<!DOCTYPE html>
<head>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='style.css') }}?v=1">
</head>
<body>
    <main>
        <button id="mode" onclick="changeMode()"><img id="img_mode" src = 'static/images/TileUnknown.png'></button>
        <table border="0" cellspacing="0" cellpadding="0">
            <tbody id="Table">
                <!-- LEAVE EMPTY!!!!! FILLED BY SCRIPT-->
            </tbody>
        </table>
    </main>
    <script>
        var mines = [];
        var flagged = [];
        var mode = "tile";
        var ended;
        var gameSize;
        function generateField(size) {
            gameSize = size;
            var tableBody = document.getElementById('Table');
            var numberOfMines = size;
            mines = placeMines(size, numberOfMines);
            console.log(mines);
            for(var x = 0; x < size; x++){
                var row = document.createElement('tr');
                for (var y = 0; y < size; y++) {
                    var tile = document.createElement('td');
                    tile.innerHTML = `<button onclick="handleClick(${x}, ${y})"><img id='${x}${y}'></button>`;
                    row.appendChild(tile);
                    tableBody.appendChild(row);
                    document.getElementById(`${x}${y}`).src=`static/images/TileUnknown.png`;
                }
            }
        }

        function placeMines(size, numberOfMines) {
            var placedMines = new Set(); 
            while (placedMines.size < numberOfMines) {
                var x = Math.floor(Math.random() * size); 
                var y = Math.floor(Math.random() * size); 
                placedMines.add(`${x},${y}`);
            }
            return Array.from(placedMines).map(mine => mine.split(',').map(Number));
        }

        function changeMode(){
            if(mode == "tile"){
                document.getElementById("img_mode").src=`static/images/TileFlag.png`;
                mode = "flag";
            } else {
                document.getElementById("img_mode").src=`static/images/TileUnknown.png`;
                mode = "tile";
            }
        }

        function checkTile(x, y) {
            if(mode == "tile"){
                if(checkMines(x,y)){
                    document.getElementById(`${x}${y}`).src=`static/images/TileExploded.png`;
                    gameOver();
                } else {
                    document.getElementById(`${x}${y}`).src=`static/images/TileEmpty.png`;
                }
            } else {
                var flagLocation = checkFlags(x,y);
                if(flagLocation){
                    document.getElementById(`${x}${y}`).src=`static/images/TileUnknown.png`;
                    flagged.splice(flagLocation - 1, 1);
                } else {
                    document.getElementById(`${x}${y}`).src=`static/images/TileFlag.png`;
                    flagged.push([x, y]);
                }
            }
        }

        function gameOver(){
            ended = 1;
            for(var x = 0; x < gameSize; x++){
                for(var y = 0; y < gameSize; y++){
                    if(checkMines(x,y)){
                        if(!checkFlags(x,y))
                        document.getElementById(`${x}${y}`).src=`static/images/TileMine.png`;
                    } 
                }
            }
        }

        function handleClick(x,y){
            if(!ended){
                checkTile(x,y);
            }
        }

        function checkMines(x,y){
            for(var i = 0; i < mines.length; i++){
                if(mines[i][0] == x && mines[i][1] == y){
                    return 1;
                }
            }
        }

        function checkFlags(x,y){
            for(var j = 0; j < flagged.length; j++){
                if(flagged[j][0] == x && flagged[j][1] == y){
                    console.log(j);
                    return j + 1;
                }
            }
        }

        document.onload = generateField(10);
    </script>
</body>